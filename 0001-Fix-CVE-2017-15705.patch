From 00a79bd318df62479df3c082f5afb2b3173935cd Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ond=C5=99ej=20Lyson=C4=9Bk?= <olysonek@redhat.com>
Date: Wed, 26 Sep 2018 17:32:18 +0200
Subject: [PATCH] Fix CVE-2017-15705

Based on the following upstream revisions:
https://svn.apache.org/viewvc?view=revision&revision=1815688
https://svn.apache.org/viewvc?view=revision&revision=1815853

Resolves: rhbz#1632998
---
 lib/Mail/SpamAssassin/HTML.pm | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/lib/Mail/SpamAssassin/HTML.pm b/lib/Mail/SpamAssassin/HTML.pm
index 14f796f..a8a7ed0 100644
--- a/lib/Mail/SpamAssassin/HTML.pm
+++ b/lib/Mail/SpamAssassin/HTML.pm
@@ -250,6 +250,11 @@ sub parse {
     $self->SUPER::parse($text);
   }
 
+  # bug 7437: deal gracefully with HTML::Parser misbehavior on unclosed <style> and <script> tags
+  # (typically from not passing the entire message to spamc, but possibly a DoS attack)
+  $self->SUPER::parse("</style>") while exists $self->{inside}{style} && $self->{inside}{style} > 0;
+  $self->SUPER::parse("</script>") while exists $self->{inside}{script} && $self->{inside}{script} > 0;
+
   $self->SUPER::eof;
 
   return $self->{text};
-- 
2.17.1

